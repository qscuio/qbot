name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Docker if needed
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Use sudo only if not root
            SUDO=""
            if [ "$(id -u)" != "0" ]; then
              SUDO="sudo"
            fi
            
            # Check if Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "ðŸ³ Docker not found. Installing..."
              curl -fsSL https://get.docker.com | sh
              $SUDO usermod -aG docker $USER || true
              echo "âœ… Docker installed"
            else
              echo "âœ… Docker is already installed: $(docker --version)"
            fi
            
            # Check if Docker Compose plugin is installed
            if ! docker compose version &> /dev/null; then
              echo "ðŸ“¦ Docker Compose not found. Installing..."
              $SUDO apt-get update
              $SUDO apt-get install -y docker-compose-plugin
              echo "âœ… Docker Compose installed"
            else
              echo "âœ… Docker Compose is already installed: $(docker compose version)"
            fi
            
            # Start Docker service if not running
            if ! $SUDO systemctl is-active --quiet docker 2>/dev/null; then
              $SUDO systemctl start docker 2>/dev/null || true
              $SUDO systemctl enable docker 2>/dev/null || true
            fi
            
            # Configure UFW firewall (if installed)
            if command -v ufw &> /dev/null; then
              echo "ðŸ”¥ Configuring UFW firewall..."
              $SUDO ufw allow ssh
              $SUDO ufw allow 80/tcp
              $SUDO ufw allow 443/tcp
              $SUDO ufw --force enable || true
              echo "âœ… UFW configured"
            fi

      - name: Setup Nginx reverse proxy
        uses: appleboy/ssh-action@v1.0.3
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          BOT_PORT: ${{ secrets.BOT_PORT || '3000' }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: WEBHOOK_URL,BOT_PORT
          script: |
            # Use sudo only if not root
            SUDO=""
            if [ "$(id -u)" != "0" ]; then
              SUDO="sudo"
            fi
            
            # Extract domain from WEBHOOK_URL
            DOMAIN=$(echo "$WEBHOOK_URL" | sed 's|https://||' | sed 's|/.*||')
            BOT_PORT=${BOT_PORT:-3000}
            echo "ðŸ“¡ Setting up Nginx for domain: $DOMAIN -> port $BOT_PORT"
            
            # Install Nginx if not present
            if ! command -v nginx &> /dev/null; then
              echo "ðŸŒ Nginx not found. Installing..."
              $SUDO apt-get update
              $SUDO apt-get install -y nginx
              $SUDO systemctl enable nginx
              echo "âœ… Nginx installed"
            else
              echo "âœ… Nginx is already installed"
            fi
            
            # Install certbot if not present
            if ! command -v certbot &> /dev/null; then
              echo "ðŸ”’ Certbot not found. Installing..."
              $SUDO apt-get install -y certbot python3-certbot-nginx
              echo "âœ… Certbot installed"
            fi
            
            # Create Nginx config for the bot
            $SUDO tee /etc/nginx/sites-available/qbot > /dev/null << NGINXCONF
            server {
                listen 80;
                server_name $DOMAIN;
                
                location / {
                    proxy_pass http://127.0.0.1:$BOT_PORT;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            NGINXCONF
            
            # Enable site if not already enabled
            if [ ! -L /etc/nginx/sites-enabled/qbot ]; then
              $SUDO ln -sf /etc/nginx/sites-available/qbot /etc/nginx/sites-enabled/qbot
            fi
            
            # Test and reload Nginx
            $SUDO nginx -t && $SUDO systemctl reload nginx
            
            # Get SSL certificate if not exists
            if [ ! -d "/etc/letsencrypt/live/$DOMAIN" ]; then
              echo "ðŸ”’ Obtaining SSL certificate..."
              $SUDO certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN || echo "âš ï¸ SSL setup failed - run: certbot --nginx -d $DOMAIN"
            else
              echo "âœ… SSL certificate already exists"
            fi

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Navigate to project directory
            cd /opt/qbot || {
              echo "Creating project directory..."
              mkdir -p /opt/qbot
              cd /opt/qbot
              git clone https://github.com/${{ github.repository }}.git .
            }
            
            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main
            
            # Create .env file from secrets
            cat > .env << 'EOF'
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            BOT_SECRET=${{ secrets.BOT_SECRET }}
            WEBHOOK_URL=${{ secrets.WEBHOOK_URL }}
            BOT_PORT=${{ secrets.BOT_PORT || '3000' }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            CLAUDE_API_KEY=${{ secrets.CLAUDE_API_KEY }}
            ALLOWED_USERS=${{ secrets.ALLOWED_USERS }}
            EOF
            
            # Build and deploy with Docker Compose
            docker compose down || true
            docker compose build --no-cache
            docker compose up -d
            
            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 15
            
            # Show container status
            docker compose ps
            
            # Check if bot is running
            if ! docker compose ps bot | grep -q "Up"; then
              echo "âŒ Bot container failed to start. Showing logs:"
              docker compose logs bot
              exit 1
            fi
            
            # Run database migrations
            echo "ðŸ—„ï¸ Running database migrations..."
            docker compose exec -T bot npm run db:push || {
              echo "âŒ Migration failed. Showing logs:"
              docker compose logs bot
              exit 1
            }
            
            # Health check
            BOT_PORT=$(grep BOT_PORT .env | cut -d= -f2 | tr -d ' ')
            BOT_PORT=${BOT_PORT:-3000}
            echo "ðŸ¥ Health check on port $BOT_PORT..."
            curl -f http://localhost:$BOT_PORT/health || {
              echo "âŒ Health check failed. Showing logs:"
              docker compose logs bot
              exit 1
            }
            
            echo "âœ… Deployment successful!"

      - name: Register Webhook
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/qbot
            
            # Check if bot is running first
            if docker compose ps bot | grep -q "Up"; then
              docker compose exec -T bot npm run setup-webhook
            else
              echo "âŒ Bot is not running, cannot register webhook"
              docker compose logs bot
              exit 1
            fi
